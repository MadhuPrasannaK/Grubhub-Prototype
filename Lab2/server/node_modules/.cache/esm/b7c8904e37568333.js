let Orders,Restaurants,Users,Promise;_375‍.x([["handle_request",()=>handle_request]]);_375‍.w("../../models/order",[["default",["Orders"],function(v){Orders=v}]]);_375‍.w("../../models/restaurant",[["default",["Restaurants"],function(v){Restaurants=v}]]);_375‍.w("../../models/user",[["default",["Users"],function(v){Users=v}]]);_375‍.w("bluebird",[["default",["Promise"],function(v){Promise=v}]]);




const handle_request = async (order_details, callback) => {
    return Orders.create({
        amount: order_details.total_amount,
        status: "NEW"
    }).then(order => {
        if (order_details.cart && order_details.cart.length) {
            order_details.cart.map(dish => {
                order.dishes.push({
                    dish_id: dish._id,
                    quantity: dish.quantity
                })
            })
        }
        return order.save().then(updatedOrder => {
            const restaurantOrderPromise = Restaurants.findById(order_details.restaurant_id).then(restaurant => {
                restaurant.orders.push(updatedOrder._id)
                return restaurant.save();
            });
            const customerOrderPromise = Users.findById(order_details.user_id).then(user => {
                user.orders.push(updatedOrder._id)
                return user.save();
            });
            return Promise.all(restaurantOrderPromise, customerOrderPromise).then(() => {
                callback(null, updatedOrder);
            }).catch(err => {
                _375‍.g.console.log(err)
                callback(err, null);
            })
        });
    });
};




